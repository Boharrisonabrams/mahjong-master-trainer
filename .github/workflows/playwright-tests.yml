name: ğŸ€„ Mahjong Trainer Premium Testing Suite

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run nightly for comprehensive testing
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'

jobs:
  # Visual Regression Testing
  visual-tests:
    name: ğŸ¨ Visual Regression Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies  
        run: npm ci
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps
        
      - name: ğŸ—ï¸ Build Application
        run: npm run build
        
      - name: ğŸ–¼ï¸ Run Visual Tests
        run: npx playwright test tests/visual/ --reporter=html
        
      - name: ğŸ“¸ Upload Visual Diffs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-test-results
          path: test-results/
          retention-days: 7

  # Cross-Browser Compatibility
  cross-browser-tests:
    name: ğŸŒ Cross-Browser Gaming Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps ${{ matrix.browser }}
        
      - name: ğŸ—ï¸ Build Application
        run: npm run build
        
      - name: ğŸ® Run Cross-Browser Tests
        run: npx playwright test tests/cross-browser/ --project=${{ matrix.browser }} --reporter=html
        
      - name: ğŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.browser }}-test-results
          path: test-results/
          retention-days: 7

  # Performance Testing
  performance-tests:
    name: âš¡ Performance & Responsiveness
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps chromium
        
      - name: ğŸ—ï¸ Build Application
        run: npm run build
        
      - name: âš¡ Run Performance Tests
        run: npx playwright test tests/performance/ --project=chromium-desktop --reporter=html
        
      - name: ğŸ“ˆ Upload Performance Metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-metrics
          path: test-results/performance-metrics/
          retention-days: 30

  # Game Flow Testing
  game-flow-tests:
    name: ğŸ¯ Game Flow & UX Validation
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps
        
      - name: ğŸ—ï¸ Build Application
        run: npm run build
        
      - name: ğŸ® Run Game Flow Tests
        run: npx playwright test tests/game-flow/ --reporter=html
        
      - name: ğŸ¯ Upload Game Flow Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: game-flow-results
          path: test-results/
          retention-days: 7

  # Advanced Game State Testing
  game-state-tests:
    name: ğŸ§  Advanced Game State Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps
        
      - name: ğŸ—ï¸ Build Application
        run: npm run build
        
      - name: ğŸ§ª Run Game State Tests
        run: npx playwright test tests/game-states/ --reporter=html
        
      - name: ğŸ§  Upload Game State Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: game-state-results
          path: test-results/
          retention-days: 7

  # Mobile Testing
  mobile-tests:
    name: ğŸ“± Mobile Gaming Experience
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: npm ci
        
      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps
        
      - name: ğŸ—ï¸ Build Application
        run: npm run build
        
      - name: ğŸ“± Run Mobile Tests
        run: npx playwright test --project=mobile-chrome --project=mobile-safari --reporter=html
        
      - name: ğŸ“² Upload Mobile Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-test-results
          path: test-results/
          retention-days: 7

  # Comprehensive Test Report
  generate-report:
    name: ğŸ“‹ Generate Premium Test Report
    needs: [visual-tests, cross-browser-tests, performance-tests, game-flow-tests, game-state-tests, mobile-tests]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-test-results
          
      - name: ğŸ“Š Generate Comprehensive Report
        run: |
          echo "# ğŸ€„ Mahjong Trainer Premium Testing Report" > test-summary.md
          echo "## Test Execution Summary" >> test-summary.md
          echo "- **Visual Regression**: ${{ needs.visual-tests.result }}" >> test-summary.md
          echo "- **Cross-Browser**: ${{ needs.cross-browser-tests.result }}" >> test-summary.md
          echo "- **Performance**: ${{ needs.performance-tests.result }}" >> test-summary.md
          echo "- **Game Flow**: ${{ needs.game-flow-tests.result }}" >> test-summary.md
          echo "- **Game States**: ${{ needs.game-state-tests.result }}" >> test-summary.md
          echo "- **Mobile**: ${{ needs.mobile-tests.result }}" >> test-summary.md
          echo "" >> test-summary.md
          echo "Generated at: $(date)" >> test-summary.md
          
      - name: ğŸ“‹ Upload Test Summary
        uses: actions/upload-artifact@v4
        with:
          name: premium-test-report
          path: test-summary.md
          retention-days: 30

  # Notify on Quality Gate
  quality-gate:
    name: ğŸšª Premium Quality Gate
    needs: [visual-tests, cross-browser-tests, performance-tests, game-flow-tests, game-state-tests, mobile-tests]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ¯ Evaluate Quality Gate
        run: |
          echo "Evaluating premium gaming experience quality..."
          
          # Check if critical tests passed
          VISUAL_RESULT="${{ needs.visual-tests.result }}"
          CROSS_BROWSER_RESULT="${{ needs.cross-browser-tests.result }}"
          PERFORMANCE_RESULT="${{ needs.performance-tests.result }}"
          
          if [[ "$VISUAL_RESULT" == "success" && "$CROSS_BROWSER_RESULT" == "success" && "$PERFORMANCE_RESULT" == "success" ]]; then
            echo "âœ… PREMIUM QUALITY GATE PASSED"
            echo "ğŸ® Ready for production-level gaming experience!"
            exit 0
          else
            echo "âŒ PREMIUM QUALITY GATE FAILED"
            echo "ğŸ”§ Quality improvements needed before release"
            exit 1
          fi